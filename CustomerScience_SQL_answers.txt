--Q1

select 
count(case when spend < 35 then ugc_id else NULL) as count, 
count(case when spend <35 then ugc_id else NULL)*1.00/ count(*) as percentage
	from (select ugc_id, max(amount) as spend
		 from 
			((select ugc_id,group_order_no,sum(amount) as amount from
			  Table 
                          where visit_date between '2018-01-01' and '2018-12-31'
                          and channel='DOTCOM' and service_id in (8,11)
                          group by ugc_id,group_order_no)a
	      group by ugc_id)b
     
-- Q2
select channel,year,month,sum(amount) over (partition by channel,Year order by month ROWS UNBOUNDED PRECEDING and current row) as revenue
from(
select channel,Year(visit_date) as Year,month(visit_date) as month, sum(amount) as amount
from Table
where channel in ('DOTCOM','OG') and YEAR(visit_date)= 2017
group by 1,2,3)a

--Q3

select year, quarter, count((case when gap in (-1,3) and (year - lead( year ,1,0) over (partition by ugc_id order by year) )) in (0,-1) then ugc_id else NULL end)) as count,
count((case when quarter -lead( quarter ,1,0) over (partition by ugc_id order by year, quarter ) in (-1,3) and (year-lead( year ,1,0) over (partition by ugc_id order by year) )) in (0,-1) then ugc_id else NULL end) /count(ugc_id)) as percentage
from
(select ugc_id,year(visit_date) as year, datepart(q,visit_date)  as quarter
 from Table 
		where channel = 'DOTCOM'
		group by ugc_id,year(visit_date), datepart(q,visit_date))a
group by 1,2

